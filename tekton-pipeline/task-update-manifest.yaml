apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: update-manifest
  namespace: default
spec:
  params:
    - name: manifest-file
      description: Path to the yaml file to update
    - name: new-image
      description: The new image tag to insert
    - name: branch
      description: The branch to push to (e.g., main)
    - name: git-email
      default: "tekton@example.com"
    - name: git-name
      default: "Tekton Pipeline"
  workspaces:
    - name: source
  steps:
    - name: git-update
      image: alpine/git:v2.36.3
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-token
              key: token
        - name: HOME
          value: /workspace/source
      script: |
        #!/bin/sh
        set -e
        
        # Trust the directory
        git config --global --add safe.directory $(workspaces.source.path)
        
        # Configure Git
        git config --global user.email "$(params.git-email)"
        git config --global user.name "$(params.git-name)"
        
        cd $(workspaces.source.path)
        
        # Setup remote
        ORIGIN_URL=$(git remote get-url origin)
        REPO_PATH=${ORIGIN_URL#https://}
        git remote set-url origin https://${GITHUB_TOKEN}@${REPO_PATH}
        
        # RETRY LOOP FOR PUSHING
        MAX_RETRIES=10
        COUNT=0
        
        while [ $COUNT -lt $MAX_RETRIES ]; do
          # 1. Pull Latest
          echo "Attempt $(($COUNT+1)): Pulling latest changes..."
          git pull origin $(params.branch) --rebase
          
          # 2. Update File
          echo "Updating $(params.manifest-file)..."
          sed -i "s|image: .*|image: $(params.new-image)|g" $(params.manifest-file)
          
          # 3. Check for changes
          if git diff --quiet $(params.manifest-file); then
            echo "No changes to commit (Image already up to date)."
            exit 0
          fi
          
          # 4. Commit
          git add $(params.manifest-file)
          # Use --allow-empty in case rebase handled it, though diff check handles most
          git commit -m "Deploy: Update image to $(params.new-image)" || true
          
          # 5. Push
          if git push origin HEAD:$(params.branch); then
            echo "Successfully pushed changes."
            exit 0
          fi
          
          echo "Push failed (likely race condition). Retrying..."
          COUNT=$(($COUNT+1))
          sleep 3 # Random backoff would be better, but fixed is fine
        done
        
        echo "Failed to push after $MAX_RETRIES attempts."
        exit 1