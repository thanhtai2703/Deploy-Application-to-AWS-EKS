apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: update-manifest
  namespace: default
spec:
  params:
    - name: image
      description: The new image tag
    - name: manifest-file
      description: The path to the yaml file
  workspaces:
    - name: source
      description: The workspace containing the cloned repo
  steps:
    - name: update-yaml
      image: alpine/git:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env sh
        set -e
        
        # Configure Git Credentials using the mounted secret
        git config --global credential.helper 'store --file=/workspace/source/.git-credentials'
        echo "https://$(cat /etc/git-creds/username):$(cat /etc/git-creds/password)@github.com" > /workspace/source/.git-credentials

        git config --global user.email "tekton@k8s.local"
        git config --global user.name "Tekton Bot"

        echo "ğŸ”§ Updating manifest: $(params.manifest-file)"
        sed -i "s|image: .*|image: $(params.image)|g" $(params.manifest-file)

        git add $(params.manifest-file)
        if git commit -m "GitOps: Update image to $(params.image)"; then
          echo "ğŸš€ Pushing changes to GitHub..."
          git push origin HEAD
        else
          echo "âš ï¸ No changes to commit"
        fi
      volumeMounts:
        - name: git-creds
          mountPath: /etc/git-creds
          readOnly: true
  volumes:
    - name: git-creds
      secret:
        secretName: git-credentials
