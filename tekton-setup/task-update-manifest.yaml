apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: update-manifest
  namespace: default
spec:
  params:
    - name: manifest-file
      description: Path to the yaml file to update
    - name: new-image
      description: The new image tag to insert
    - name: branch
      description: The branch to push to (e.g., main)
    - name: git-email
      default: "tekton@example.com"
    - name: git-name
      default: "Tekton Pipeline"
  workspaces:
    - name: source
  steps:
    - name: git-update
      image: alpine/git:v2.36.3
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-token
              key: token
        - name: HOME
          value: /workspace/source
      script: |
        #!/bin/sh
        set -e
        
        # Trust the directory
        git config --global --add safe.directory $(workspaces.source.path)
        
        # Configure Git
        git config --global user.email "$(params.git-email)"
        git config --global user.name "$(params.git-name)"
        
        cd $(workspaces.source.path)
        
        # Setup remote with token
        ORIGIN_URL=$(git remote get-url origin)
        REPO_PATH=${ORIGIN_URL#https://}
        git remote set-url origin https://${GITHUB_TOKEN}@${REPO_PATH}
        
        # Pull latest changes explicitly from the target branch
        echo "Pulling latest changes from $(params.branch)..."
        git pull origin $(params.branch) --rebase
        
        # Update the file
        echo "Updating $(params.manifest-file) with image $(params.new-image)"
        sed -i "s|image: .*|image: $(params.new-image)|g" $(params.manifest-file)
        
        # Commit
        git add $(params.manifest-file)
        git commit -m "Deploy: Update image to $(params.new-image)"
        
        # Push Explicitly to the branch
        echo "Pushing to $(params.branch)..."
        git push origin HEAD:$(params.branch)
